#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

echo "== ProtectPibble bootstrap =="

export NPM_CONFIG_CACHE="${ROOT_DIR}/.cache/npm"
export PIP_CACHE_DIR="${ROOT_DIR}/.cache/pip"
mkdir -p "${NPM_CONFIG_CACHE}" "${PIP_CACHE_DIR}"

if [[ ! -f "${ROOT_DIR}/.env" && -f "${ROOT_DIR}/env.example" ]]; then
  echo "Creating .env from env.example"
  cp "${ROOT_DIR}/env.example" "${ROOT_DIR}/.env"
fi

echo "Installing frontend deps"
(cd "${ROOT_DIR}/frontend" && npm install)

echo "Creating backend venv (backend/.venv)"
if [[ ! -d "${ROOT_DIR}/backend/.venv" ]]; then
  (cd "${ROOT_DIR}/backend" && python3 -m venv .venv)
fi

echo "Installing backend deps"
(cd "${ROOT_DIR}/backend" && . .venv/bin/activate && pip install --upgrade pip && pip install -r requirements.txt -r requirements-dev.txt)

if command -v docker >/dev/null 2>&1 && docker compose version >/dev/null 2>&1; then
  echo "Starting local services (postgres + redis)"
  (cd "${ROOT_DIR}" && docker compose up -d)
else
  echo "Docker not found; skipping docker compose up"
fi

echo "Done."

