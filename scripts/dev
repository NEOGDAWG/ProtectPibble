#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

if [[ ! -f "${ROOT_DIR}/.env" && -f "${ROOT_DIR}/env.example" ]]; then
  echo "Creating .env from env.example"
  cp "${ROOT_DIR}/env.example" "${ROOT_DIR}/.env"
fi

if [[ ! -d "${ROOT_DIR}/backend/.venv" ]]; then
  echo "Missing backend/.venv. Run ./scripts/bootstrap first."
  exit 1
fi

cleanup() {
  if [[ -n "${BACKEND_PID:-}" ]]; then kill "${BACKEND_PID}" >/dev/null 2>&1 || true; fi
  if [[ -n "${FRONTEND_PID:-}" ]]; then kill "${FRONTEND_PID}" >/dev/null 2>&1 || true; fi
}
trap cleanup EXIT

echo "Starting backend on http://127.0.0.1:8000"
(cd "${ROOT_DIR}/backend" && . .venv/bin/activate && set -a && source "${ROOT_DIR}/.env" && set +a && uvicorn app.main:app --reload --host "${BACKEND_HOST:-127.0.0.1}" --port "${BACKEND_PORT:-8000}") &
BACKEND_PID=$!

echo "Starting frontend on http://127.0.0.1:5173"
(cd "${ROOT_DIR}/frontend" && set -a && source "${ROOT_DIR}/.env" && set +a && npm run dev -- --host "${FRONTEND_HOST:-127.0.0.1}" --port "${FRONTEND_PORT:-5173}") &
FRONTEND_PID=$!

wait

